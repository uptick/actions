name: Claude Code Mention

### Usage:
# on:
#   issue_comment:
#     types: [created]
#   pull_request_review_comment:
#     types: [created]
#   issues:
#     types: [opened, assigned]
#   pull_request_review:
#     types: [submitted]

on:
  workflow_call:
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        description: "The OAuth token for Claude Code; if using personal access token"
        required: false
      CLAUDE_CODE_OAUTH_TOKEN_POOL:
        description: "Newline-separated pool of OAuth tokens for Claude Code; one is randomly selected per run"
        required: false
      ANTHROPIC_API_KEY:
        description: "The API token for Claude Code; if using API key (for api based billing)"
        required: false

permissions:
  id-token: write
  contents: write
  pull-requests: write # permissions for claude to comment on the pull request
  issues: write # permissions for claude to comment on the pull request
  actions: read # Required for Claude to read CI results on PRs

jobs:
  claude:
    timeout-minutes: 10
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6.0.2
        with:
          fetch-depth: 1
      - name: Select OAuth token from pool
        id: select-token
        shell: bash
        run: |
          if [ -n "$POOL" ]; then
            # Read tokens into array, mask each one
            mapfile -t TOKENS <<< "$POOL"
            VALID_TOKENS=()
            for token in "${TOKENS[@]}"; do
              token=$(echo "$token" | xargs)  # trim whitespace
              [ -z "$token" ] && continue
              echo "::add-mask::$token"
              VALID_TOKENS+=("$token")
            done
            # Random selection
            INDEX=$(( RANDOM % ${#VALID_TOKENS[@]} ))
            SELECTED="${VALID_TOKENS[$INDEX]}"
            echo "selected=$SELECTED" >> "$GITHUB_OUTPUT"
            echo "Token pool: ${#VALID_TOKENS[@]} tokens available, selected index $INDEX"
          else
            echo "::add-mask::$SINGLE"
            echo "selected=$SINGLE" >> "$GITHUB_OUTPUT"
            echo "Using single CLAUDE_CODE_OAUTH_TOKEN"
          fi
        env:
          POOL: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN_POOL }}
          SINGLE: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@ea36d6abdedc17fc2a671b36060770b208a6f8f1 # v1
        with:
          claude_code_oauth_token: ${{ steps.select-token.outputs.selected }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true # âœ¨ Enables tracking comments
          claude_args: >-
            --model claude-opus-4-6
