# Reusable GitHub Action for Claude Code to review a pull request.
# Reviews the ENTIRE PR diff (not just the latest commit).

on:
  workflow_call:
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        description: "The OAuth token for Claude Code; if using personal access token"
        required: false
      CLAUDE_CODE_OAUTH_TOKEN_POOL:
        description: "Newline-separated pool of OAuth tokens for Claude Code; one is randomly selected per run"
        required: false
      ANTHROPIC_API_KEY:
        description: "The API token for Claude Code; if using API key (for api based billing)"
        required: false

permissions:
  id-token: write
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      (github.event_name == 'pull_request' && !github.event.pull_request.draft && !contains(github.event.pull_request.labels.*.name, 'NOCLAUDE') && !contains(github.event.pull_request.user.login, 'uptick-renovate'))
    steps:
      - name: Calculate PR fetch depth
        run: echo "PR_FETCH_DEPTH=$(( ${{ github.event.pull_request.commits }} + 1 ))" >> "${GITHUB_ENV}"

      - name: Checkout PR branch and all PR commits
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6.0.2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: ${{ env.PR_FETCH_DEPTH }}

      - name: Fetch target branch (shallow)
        run: git fetch origin ${{ github.event.pull_request.base.ref }}:${{ github.event.pull_request.base.ref }} --depth=1

      - name: Select OAuth token from pool
        id: select-token
        shell: bash
        run: |
          if [ -n "$POOL" ]; then
            # Read tokens into array, mask each one
            mapfile -t TOKENS <<< "$POOL"
            VALID_TOKENS=()
            for token in "${TOKENS[@]}"; do
              token=$(echo "$token" | xargs)  # trim whitespace
              [ -z "$token" ] && continue
              echo "::add-mask::$token"
              VALID_TOKENS+=("$token")
            done
            # Random selection
            INDEX=$(( RANDOM % ${#VALID_TOKENS[@]} ))
            SELECTED="${VALID_TOKENS[$INDEX]}"
            echo "selected=$SELECTED" >> "$GITHUB_OUTPUT"
            echo "Token pool: ${#VALID_TOKENS[@]} tokens available, selected index $INDEX"
          else
            echo "::add-mask::$SINGLE"
            echo "selected=$SINGLE" >> "$GITHUB_OUTPUT"
            echo "Using single CLAUDE_CODE_OAUTH_TOKEN"
          fi
        env:
          POOL: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN_POOL }}
          SINGLE: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: PR Review with Progress Tracking
        uses: anthropics/claude-code-action@6c61301d8e1ee91bef7b65172f93462bbb216394 # ratchet:anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_code_oauth_token: ${{ steps.select-token.outputs.selected }}
          use_sticky_comment: true
          claude_args: >-
            --model claude-opus-4-6
            --allowedTools "mcp__github__get_pull_request_diff,mcp__github_inline_comment__create_inline_comment,mcp__github__get_pull_request_comments,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(git diff:*),Bash(gh api:*),Read,Grep,Glob"
            --disallowedTools "Bash(*gh pr review*),Bash(*addPullRequestReview*),Bash(*submitPullRequestReview*),Bash(*dismissPullRequestReview*),Bash(*createPullRequestReview*),Bash(*pulls/*/reviews*)"
            --print
            --output-format stream-json

          prompt: |-
            # Code Review Task

            You are an expert Senior Software Engineer reviewing a pull request.

            **CRITICAL: You must NEVER create, submit, or dismiss GitHub PR reviews. Do not use `gh pr review`, the `pulls/*/reviews` API endpoint, or any review-related GraphQL mutations (addPullRequestReview, submitPullRequestReview, dismissPullRequestReview). Only provide feedback via inline comments and PR comments.**

            **Repository:** ${{ github.repository }}
            **PR Number:** ${{ github.event.pull_request.number }}
            **Base Branch:** ${{ github.event.pull_request.base.ref }}
            **Head Branch:** ${{ github.event.pull_request.head.ref }}

            The PR branch is already checked out in the current working directory.

            ---

            ## Step 1: Gather Context

            First, check for repository-specific review guidelines:
            - Read `CLAUDE.md` or `AGENTS.md` for patterns/context/best practices
            - If `AGENTS_CODEREVIEW.md` exists, follow those instructions instead of the defaults below

            ---

            ## Step 2: Get the Full PR Diff

            Review the ENTIRE pull request, not just the latest commit.

            Run these commands in order:

            **2a. Get PR metadata and list of changed files:**
            ```bash
            gh pr view ${{ github.event.pull_request.number }} --json files,reviews,title,body,headRefOid,baseRefOid
            ```

            **2b. Get the full PR diff (base to head):**
            ```bash
            gh pr diff ${{ github.event.pull_request.number }}
            ```

            **2c. Get existing review comments to avoid duplicates:**
            ```bash
            gh api graphql -f query='
              query {
                repository(owner: "${{ github.repository_owner }}", name: "${{ github.event.repository.name }}") {
                  pullRequest(number: ${{ github.event.pull_request.number }}) {
                    reviewThreads(first: 100) {
                      nodes {
                        id
                        isResolved
                        isOutdated
                        path
                        line
                        startLine
                        comments(first: 10) {
                          nodes {
                            id
                            body
                            databaseId
                            author { login }
                          }
                        }
                      }
                    }
                  }
                }
              }'
            ```

            ---

            ## Step 3: Review Focus Areas

            <default-code-review-instructions>
            **Bugs**:
            - Identify logical errors
            - Potential bugs introduced when interfaces / apis change. Follow the changes to identify any downstream impact / concerns.
            - Validation issues

            **Code Quality:**
            - Clean code principles and best practices
            - Proper error handling and edge cases
            - Code readability and maintainability

            **Security:**
            - Potential security vulnerabilities
            - Embedded secrets or credentials
            - PII leaks and hardcoded sensitive values
            - Input sanitization
            - Authentication/authorization logic

            **Performance:**
            - Performance bottlenecks
            - Database query efficiency
            - Memory leaks or resource issues

            **Testing:**
            - Adequate test coverage
            - Test quality and edge cases
            - Missing test scenarios

            **Ignore:**
            - Grammar and spelling
            - Formatting and style nitpicks

            Only flag issues you are CERTAIN about. Do not annoy the developer with non-critical feedback.

            </default-code-review-instructions>

            ---

            ## Step 4: Post Review Comments

            **Rules:**
            - DO NOT write to files
            - DO NOT use shell substitution or backticks in bash commands (security sandbox blocks them)
            - Only post when you have a concrete, actionable fix and are VERY CONFIDENT
            - Skip if a similar comment already exists for that line

            **For new issues, use inline comments:**
            Use `mcp__github_inline_comment__create_inline_comment` to highlight specific code issues.

            **To reply to an existing comment:**
            ```bash
            gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments/<COMMENT-ID>/replies --method POST --field body="<YOUR-REPLY>"
            ```

            **To update an existing comment:**
            ```bash
            gh api repos/${{ github.repository }}/issues/comments/<COMMENT-ID> --method PATCH --field body="<UPDATED-TEXT>"
            ```

            ---

            ## Step 5: Resolve Fixed Issues

            For threads created by "claude" that are now resolved (developer fixed the issue or code was deleted):

            1. Leave a brief comment explaining why it's resolved
            2. Resolve the thread:
            ```bash
            gh api graphql -f query='
              mutation {
                resolveReviewThread(input: {threadId: "<THREAD-ID>"}) {
                  thread { id isResolved }
                }
              }'
            ```

            **Important:** Only resolve threads YOU created. Do not resolve threads from other reviewers.
